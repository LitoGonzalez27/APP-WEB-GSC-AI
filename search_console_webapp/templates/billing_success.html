<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Completado - ClicandSEO</title>
    
    <!-- SEO/Privacidad seg√∫n feedback experto -->
    <meta name="robots" content="noindex,nofollow">
    <meta name="description" content="Confirmaci√≥n de pago - ClicandSEO">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicons/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicons/favicon.svg') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicons/favicon.ico') }}" />
    
    <!-- Consistencia visual con Manual AI Overview -->
    <link href="{{ url_for('static', filename='estilos-principales.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='base-y-componentes.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='manual-ai.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='paywall.css') }}" rel="stylesheet">
    <!-- Estilos propios de Billing Success -->
    <link href="{{ url_for('static', filename='billing-success.css') }}" rel="stylesheet">
    
</head>
<body class="billing-success-body hide-icons">
    <div class="billing-success-container">
        <div class="billing-card">
            
            <!-- HEADER DE CONFIRMACI√ìN -->
            <div class="billing-header">
                {% if payment_status == 'confirmed' %}
                    <h1 class="billing-title">Pago Completado</h1>
                {% elif payment_status == 'webhook_pending' %}
                    <h1 class="billing-title">Pago Realizado</h1>
                {% elif payment_status == 'failed' %}
                    <h1 class="billing-title">Pago Fallido</h1>
                {% else %}
                    <h1 class="billing-title">Procesando Pago</h1>
                {% endif %}
            </div>

            {% if transaction_data and (transaction_data.transaction_id or transaction_data.plan or transaction_data.amount_total) %}
            <!-- RESUMEN DE LA OPERACI√ìN -->
            <div class="transaction-details">
                <h3 style="color: var(--manual-ai-primary); margin: 0 0 var(--manual-ai-spacing-md) 0; font-size: 1.1rem; font-weight: 600;">
                    Resumen de la Operaci√≥n
                </h3>
                
                {% if transaction_data.transaction_id %}
                <div class="detail-row">
                    <span class="detail-label">N¬∫ de Pedido:</span>
                    <span class="detail-value">{{ transaction_data.transaction_id[-8:] }}</span>
                </div>
                {% endif %}
                
                {% if transaction_data.created_at %}
                <div class="detail-row">
                    <span class="detail-label">Fecha y Hora:</span>
                    <span class="detail-value">{{ transaction_data.created_at.strftime('%d/%m/%Y %H:%M') }} (CET)</span>
                </div>
                {% endif %}
                
                {% if transaction_data.plan %}
                <div class="detail-row">
                    <span class="detail-label">Plan Contratado:</span>
                    <span class="detail-value">{{ transaction_data.plan|title }} mensual</span>
                </div>
                {% endif %}
                
                {% if transaction_data.amount_total %}
                <div class="detail-row">
                    <span class="detail-label">Importe Total:</span>
                    <span class="detail-value amount-highlight">{{ '%.2f'|format(transaction_data.amount_total/100) }} {{ transaction_data.currency }}</span>
                </div>
                {% endif %}
                
                {% if transaction_data.current_period_end %}
                <div class="detail-row">
                    <span class="detail-label">Pr√≥xima Renovaci√≥n:</span>
                    <span class="detail-value">{{ transaction_data.current_period_end.strftime('%d/%m/%Y') }}</span>
                </div>
                {% endif %}
                
                {% if transaction_data.invoice_url %}
                <div class="detail-row">
                    <span class="detail-label">Factura:</span>
                    <span class="detail-value">
                        <a href="{{ transaction_data.invoice_url }}" target="_blank" style="color: var(--manual-ai-primary); text-decoration: none; font-weight: 500;">
                            Descargar Factura
                        </a>
                    </span>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- ESTADO DE LA CUENTA -->
            <div class="transaction-details">
                <h3 style="color: var(--manual-ai-primary); margin: 0 0 var(--manual-ai-spacing-md) 0; font-size: 1.1rem; font-weight: 600;">
                    Estado de la Cuenta
                </h3>
                
                <div class="detail-row">
                    <span class="detail-label">Email del Titular:</span>
                    <span class="detail-value">{{ user.email }}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Estado de Suscripci√≥n:</span>
                    <span class="detail-value">
                        {% if user_status.billing_status == 'active' %}
                            <span class="status-badge status-confirmed">Activa</span>
                        {% elif user_status.billing_status == 'trialing' %}
                            <span class="status-badge status-processing">Prueba</span>
                        {% elif user_status.billing_status == 'past_due' %}
                            <span class="status-badge status-failed">Pago Pendiente</span>
                        {% else %}
                            <span class="status-badge status-processing">{{ user_status.billing_status|title }}</span>
                        {% endif %}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Plan Actual:</span>
                    <span class="detail-value">{{ user_status.plan|title }}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Quota Disponible:</span>
                    <span class="detail-value">{{ user_status.quota_limit - user_status.quota_used }}/{{ user_status.quota_limit }} RU</span>
                </div>
            </div>

            <!-- BOTONES DE ACCI√ìN -->
            <div class="action-buttons">
                <a href="/billing/portal" class="btn-secondary btn-no-underline">Gestionar Facturaci√≥n</a>
                <a href="/" class="btn-primary btn-no-underline">Ir a la App</a>
                {% if payment_status == 'webhook_pending' %}
                <button onclick="location.reload()" class="btn-secondary">Actualizar Estado</button>
                {% endif %}
                {% if payment_status == 'failed' %}
                <a href="/billing/portal" class="btn-primary btn-no-underline">Reintentar Pago</a>
                {% endif %}
            </div>

            <!-- SOPORTE Y CONFIANZA -->
            <div class="support-section">
                <h4 style="color: var(--manual-ai-primary); margin: 0 0 var(--manual-ai-spacing-sm) 0; font-weight: 600;">
                    ¬øNecesitas ayuda?
                </h4>
                <p style="color: var(--manual-ai-gray-700); margin: 0;">
                    Contacta con nuestro equipo en 
                    <a href="mailto:hola@clicandseo.com" style="color: var(--manual-ai-primary); text-decoration: none; font-weight: 500;">
                        hola@clicandseo.com
                    </a>
                </p>
                <p style="color: var(--manual-ai-gray-600); font-size: 0.875rem; margin: var(--manual-ai-spacing-xs) 0 0 0;">
                    Respondemos en menos de 24 horas
                </p>
            </div>

            
        </div>
    </div>
    
    <!-- JavaScript mejorado para verificaci√≥n inteligente -->
    <script>
        // ‚úÖ VERIFICACI√ìN INTELIGENTE seg√∫n estado actual
        let verificationAttempts = 0;
        const maxAttempts = 6; // 1 minuto m√°ximo para webhooks pending
        const paymentStatus = '{{ payment_status }}';
        
        function verifyPlanActivation() {
            // Solo verificar si estamos en estado webhook_pending
            if (paymentStatus !== 'webhook_pending') {
                return;
            }
            
            verificationAttempts++;
            
            fetch('/api/billing/verify-activation')
                .then(response => response.json())
                .then(data => {
                    console.log('üîç Verificaci√≥n de activaci√≥n:', data);
                    
                    if (data.activated && data.plan !== 'free') {
                        // ‚úÖ PLAN ACTIVADO - Recargar p√°gina para mostrar estado confirmado
                        console.log('‚úÖ Plan activado - recargando p√°gina');
                        location.reload();
                        
                    } else if (verificationAttempts >= maxAttempts) {
                        // ‚ùå TIMEOUT - Mostrar bot√≥n de actualizar manual
                        console.warn('‚ö†Ô∏è Timeout en verificaci√≥n - mostrando bot√≥n manual');
                        const updateButton = document.querySelector('[onclick="location.reload()"]');
                        if (updateButton) {
                            updateButton.style.display = 'inline-block';
                            updateButton.textContent = 'üîÑ Actualizar Estado';
                        }
                        
                    } else {
                        // üîÑ CONTINUAR VERIFICANDO
                        console.log(`üîÑ Verificando... intento ${verificationAttempts}/${maxAttempts}`);
                        setTimeout(verifyPlanActivation, 10000);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error verificando activaci√≥n:', error);
                    // En caso de error, mostrar bot√≥n de actualizaci√≥n manual
                    const updateButton = document.querySelector('[onclick="location.reload()"]');
                    if (updateButton) {
                        updateButton.style.display = 'inline-block';
                    }
                });
        }
        
        // Iniciar verificaci√≥n inteligente
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéâ Success page profesional cargada');
            console.log('üí≥ Estado del pago:', paymentStatus);
            
            // Solo iniciar verificaci√≥n autom√°tica si estamos esperando webhook
            if (paymentStatus === 'webhook_pending') {
                console.log('‚è≥ Iniciando verificaci√≥n autom√°tica de webhook');
                setTimeout(verifyPlanActivation, 2000); // Esperar 2s inicial
            } else {
                console.log('‚úÖ Estado final alcanzado - no verificaci√≥n necesaria');
            }
        });
        
        // Funci√≥n para refresh manual
        function refreshPaymentStatus() {
            console.log('üîÑ Refresh manual solicitado');
            location.reload();
        }
    </script>
</body>
</html>