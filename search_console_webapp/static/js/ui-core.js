// Actualizaci√≥n de ui-core.js para integrar el nuevo selector de fechas

import { elems } from './utils.js';
import { 
  fetchData, 
  buildPeriodSummary, // ‚úÖ ACTUALIZADO: usar la nueva funci√≥n
  processUrlsForComparison, // ‚úÖ NUEVO: importar funci√≥n para URLs
  hasUrlComparison, // ‚úÖ NUEVO: importar funci√≥n de detecci√≥n
  generateUrlsStats // ‚úÖ NUEVO: importar estad√≠sticas de URLs
} from './data.js';
import { showProgress, completeProgress } from './ui-progress.js';
import {
  renderSummary,
  renderKeywords,
  renderInsights,
  renderTable,
  renderTableError
} from './ui-render.js';
import { renderKeywordComparisonTable, clearKeywordComparisonTable } from './ui-keyword-comparison-table.js';
import { enableAIOverviewAnalysis } from './ui-ai-overview.js';
import { 
  initStickyActions, 
  showStickyActions, 
  hideStickyActions, 
  updateStickyData 
} from './ui-sticky-actions.js';

// ‚úÖ IMPORTAR el nuevo selector de fechas
import { 
  initDateRangeSelector, 
  getSelectedDates, 
  validateSelectedDates 
} from './ui-date-selector.js';

// ‚úÖ REEMPLAZAR initMonthChips con initDateRangeSelector
export function initMonthChips() {
  // Inicializar el nuevo selector de fechas en lugar de chips
  initDateRangeSelector();
  console.log('‚úÖ Date Range Selector initialized');
}

// ‚úÖ ACTUALIZAR handleFormSubmit para trabajar con fechas espec√≠ficas
export async function handleFormSubmit(e) {
  e.preventDefault();
  if (!elems.form) {
    console.error("Formulario no encontrado.");
    alert("Error: formulario no disponible.");
    return;
  }

  // ‚úÖ NUEVO: Validar fechas seleccionadas
  const dateValidation = validateSelectedDates();
  if (!dateValidation.isValid) {
    const errorMessage = dateValidation.errors.join('\n');
    alert(`Error en las fechas seleccionadas:\n\n${errorMessage}`);
    return;
  }

  // ‚úÖ NUEVO: Obtener fechas del selector
  const selectedDates = getSelectedDates();
  if (!selectedDates) {
    alert('Error: no se pudieron obtener las fechas seleccionadas.');
    return;
  }

  console.log('üìÖ Fechas seleccionadas:', selectedDates);

  // ‚úÖ ARREGLO CR√çTICO: Verificar que site_url est√© seleccionado
  if (!elems.siteUrlSelect || !elems.siteUrlSelect.value) {
    alert('Error: You must select a domain before continuing.');
    return;
  }

  const formData = new FormData(elems.form);

  // ‚úÖ ARREGLO CR√çTICO: Asegurar que site_url se incluya
  formData.set('site_url', elems.siteUrlSelect.value);

  // ‚úÖ NUEVO: Agregar fechas espec√≠ficas al FormData
  formData.set('current_start_date', selectedDates.currentPeriod.startDate);
  formData.set('current_end_date', selectedDates.currentPeriod.endDate);
  
  // Agregar datos de comparaci√≥n si existen
  if (selectedDates.hasComparison && selectedDates.comparisonPeriod) {
    formData.set('has_comparison', 'true');
    formData.set('comparison_start_date', selectedDates.comparisonPeriod.startDate);
    formData.set('comparison_end_date', selectedDates.comparisonPeriod.endDate);
    formData.set('comparison_mode', selectedDates.comparisonMode);
  } else {
    formData.set('has_comparison', 'false');
  }

  // ‚úÖ ARREGLO: Obtener match_type de los radio buttons
  const matchTypeElement = document.querySelector('input[name="match_type"]:checked');
  if (matchTypeElement) {
    formData.set('match_type', matchTypeElement.value);
  } else {
    formData.set('match_type', 'contains'); // default value
  }

  // ‚úÖ CORREGIDO: L√≥gica de pa√≠s que respeta "Todos los pa√≠ses"
  const countryToUse = window.getCountryToUse ? window.getCountryToUse() : null;

  // ‚úÖ NUEVO: Solo a√±adir al FormData si hay un pa√≠s espec√≠fico seleccionado
  if (countryToUse) {
    formData.set('country', countryToUse);
    const countryName = window.getCountryName ? window.getCountryName(countryToUse) : countryToUse;
    console.log(`üéØ Consulta con filtro de pa√≠s: ${countryName}`);
  } else {
    // ‚úÖ NUEVO: Expl√≠citamente NO a√±adir 'country' al FormData
    // Esto hace que el backend NO aplique filtro de pa√≠s = todos los pa√≠ses
    console.log('üåç Consulta SIN filtro de pa√≠s (todos los pa√≠ses)');
  }

  // ‚úÖ DEBUGGING: Log del FormData para verificar
  console.log('üìã Datos que se enviar√°n:');
  const hasCountryFilter = formData.has('country');
  console.log(`  Filtro de pa√≠s: ${hasCountryFilter ? `S√ç (${formData.get('country')})` : 'NO (todos los pa√≠ses)'}`);

  for (const [key, value] of formData.entries()) {
    console.log(`  ${key}: ${value}`);
  }

  // Reset UI
  hideStickyActions();
  
  [
    elems.insightsSection, elems.performanceSection,
    elems.keywordsSection, elems.resultsSection,
    elems.downloadBlock, elems.aiOverviewSection
  ].forEach(el => el && (el.style.display = 'none'));

  [
    elems.insightsTitle, elems.performanceTitle,
    elems.keywordsTitle, elems.resultsTitle,
    elems.keywordComparisonTableTitle, elems.aiOverviewTitle
  ].forEach(el => el && (el.style.display = 'none'));

  if (elems.disclaimerBlock) elems.disclaimerBlock.innerHTML = '';
  if (elems.keywordOverviewDiv) elems.keywordOverviewDiv.innerHTML = '';
  if (elems.keywordCategoryDiv) elems.keywordCategoryDiv.innerHTML = '';
  clearKeywordComparisonTable();
  if (elems.tableBody) elems.tableBody.innerHTML = '';
  if (elems.aiAnalysisMessage) elems.aiAnalysisMessage.innerHTML = '';
  if (elems.aiOverviewResultsContainer) elems.aiOverviewResultsContainer.innerHTML = '';

  window.currentData = null;
  window.currentAIOverviewData = null;

  // ‚úÖ NUEVO: Pasos de progreso actualizados para fechas espec√≠ficas
  const steps = [
    'Validating dates and preparing query‚Ä¶',
    'Getting main period data‚Ä¶',
    selectedDates.hasComparison ? 'Getting comparison period data‚Ä¶' : null,
    'Processing URL metrics‚Ä¶',
    selectedDates.hasComparison ? 'Calculating period comparisons‚Ä¶' : null,
    'Generating summaries and charts‚Ä¶',
    'Finishing analysis‚Ä¶'
  ].filter(Boolean); // Eliminar elementos null

  showProgress(steps);

  try {
    const data = await fetchData(formData);
    
    if (data.error && data.reauth_required) {
        alert(data.error + "\nPor favor, recarga la p√°gina para re-autenticar.");
        completeProgress();
        return;
    }
    
    if (data.error) {
        alert("Error del servidor: " + data.error);
        renderTableError();
        if(elems.keywordComparisonTableBody) {
          elems.keywordComparisonTableBody.innerHTML = '<tr><td colspan="13">Error al cargar datos del servidor.</td></tr>';
        }
        if(elems.keywordsSection) elems.keywordsSection.style.display = 'block';
        if(elems.keywordComparisonTableTitle) elems.keywordComparisonTableTitle.style.display = 'block';
        completeProgress();
        return;
    }

    window.currentData = data;

    // ‚úÖ NUEVO: Procesar informaci√≥n del modo de an√°lisis
    if (data.analysis_info) {
      console.log('üìä Modo de an√°lisis:', data.analysis_info);
      
      // Mostrar informaci√≥n del modo de an√°lisis en la UI
      if (window.displayAnalysisMode) {
        window.displayAnalysisMode(data.analysis_info);
      }
    }

    // ‚úÖ DEBUGGING: Log de datos recibidos
    console.log('üìä Datos recibidos:', {
      keywordStats: data.keywordStats,
      keywordComparisonCount: data.keyword_comparison_data?.length || 0,
      urlsCount: data.pages?.length || 0,
      summaryCount: data.summary?.length || 0,
      periods: data.periods,
      analysisMode: data.analysis_mode
    });

    

    // ‚úÖ MODIFICADO: Usar datos de summary para m√©tricas agregadas, pages para tabla
    const summaryData = data.summary && data.summary.length > 0 ? data.summary : data.pages;
    const summary = buildPeriodSummary(summaryData, data.periods);
    renderSummary(summary);

    renderKeywords(data.keywordStats);
    
    // ‚úÖ CAMBIO PRINCIPAL: Pasar tambi√©n la informaci√≥n de per√≠odos
    renderKeywordComparisonTable(data.keyword_comparison_data || [], data.periods);

    const siteUrlForAI = elems.siteUrlSelect ? elems.siteUrlSelect.value : '';
    enableAIOverviewAnalysis(data.keyword_comparison_data || [], siteUrlForAI);

    renderInsights(summary);
    
    // ‚úÖ NUEVO: Renderizar tabla de URLs con nueva l√≥gica
    renderTable(data.pages);

    // ‚úÖ NUEVO: Generar estad√≠sticas adicionales de URLs si hay comparaci√≥n
    if (hasUrlComparison(data.pages)) {
      const urlsData = processUrlsForComparison(data.pages, data.periods);
      const urlsStats = generateUrlsStats(urlsData);
      console.log('üìã Estad√≠sticas de URLs generadas:', urlsStats);
      
      // ‚úÖ Opcional: Agregar al t√≠tulo informaci√≥n sobre URLs
      if (elems.resultsTitle) {
        const baseTitle = elems.resultsTitle.textContent;
        if (!baseTitle.includes('URLs:')) {
          elems.resultsTitle.textContent = `${baseTitle} (${urlsStats.total_urls} URLs analyzed)`;
        }
      }
    }

    const keywordData = data.keyword_comparison_data || [];
    updateStickyData(keywordData, siteUrlForAI);
    
    // ‚úÖ NUEVO: Actualizar datos del overlay AI
    if (window.updateAIOverlayData) {
      window.updateAIOverlayData(keywordData, siteUrlForAI);
    }
    
    showStickyActions();

  } catch (err) {
    console.error("Error en handleFormSubmit:", err);
    alert("Se produjo un error al procesar tu solicitud: " + err.message);
    renderTableError();
    if(elems.keywordComparisonTableBody) {
      elems.keywordComparisonTableBody.innerHTML = '<tr><td colspan="13">Error al procesar la solicitud.</td></tr>';
    }
    if(elems.keywordsSection) elems.keywordsSection.style.display = 'block';
    if(elems.keywordComparisonTableTitle) elems.keywordComparisonTableTitle.style.display = 'block';
  } finally {
    completeProgress();
  }
}


// ‚úÖ FUNCI√ìN auxiliar para formatear per√≠odos en t√≠tulos
function formatPeriodForTitle(period) {
  if (!period.start_date || !period.end_date) return 'Undefined period';
  
  const startDate = new Date(period.start_date);
  const endDate = new Date(period.end_date);
  
  // Si es el mismo d√≠a
  if (period.start_date === period.end_date) {
    return startDate.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }
  
  // Si es el mismo mes
  if (startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear()) {
    return `${startDate.getDate()}-${endDate.getDate()} ${startDate.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' })}`;
  }
  
  // Per√≠odo completo
  const startStr = startDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
  const endStr = endDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
  
  return `${startStr} - ${endStr}`;
}

// ‚úÖ MANTENER initDownloadExcel sin cambios
export function initDownloadExcel() {
  initStickyActions();
  
  if (elems.downloadExcelBtn) {
    console.log('‚ö†Ô∏è Bot√≥n Excel original detectado - deber√≠a estar oculto en favor de botones sticky');
  }
}

// ‚úÖ NUEVA funci√≥n para debugging del selector de fechas
window.debugDateSelector = function() {
  if (window.dateSelector) {
    console.log('=== DEBUG DATE SELECTOR ===');
    console.log('Fechas seleccionadas:', window.dateSelector.getFormattedDates());
    console.log('Validaci√≥n:', window.dateSelector.validateDates());
    console.log('Per√≠odo actual:', window.dateSelector.currentPeriod);
    console.log('Per√≠odo comparaci√≥n:', window.dateSelector.comparisonPeriod);
    console.log('Modo comparaci√≥n:', window.dateSelector.comparisonMode);
    console.log('==========================');
  } else {
    console.warn('Date selector not initialized');
  }
};

// ‚úÖ NUEVA funci√≥n para debugging de URLs
window.debugUrlsTable = function() {
  if (window.currentData && window.currentData.pages) {
    console.log('=== DEBUG URLS TABLE ===');
    const hasComparison = hasUrlComparison(window.currentData.pages);
    console.log('¬øTiene comparaci√≥n?:', hasComparison);
    console.log('Total p√°ginas:', window.currentData.pages.length);
    
    window.currentData.pages.forEach((page, index) => {
      console.log(`P√°gina ${index + 1}:`, {
        url: page.URL,
        metricsCount: page.Metrics ? page.Metrics.length : 0,
        metrics: page.Metrics
      });
    });
    
    if (hasComparison) {
      const processedUrls = processUrlsForComparison(window.currentData.pages, window.currentData.periods);
      console.log('URLs procesadas:', processedUrls);
      
      const stats = generateUrlsStats(processedUrls);
      console.log('Estad√≠sticas:', stats);
    }
    console.log('========================');
  } else {
    console.warn('No data loaded for debugging');
  }
};